<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mechanic Dashboard | Vehicle Assistance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <!-- Navbar will be rendered here -->
    <div id="navbar-placeholder"></div>

    <div class="container mt-4">
      <!-- messages -->
      <div id="messages-placeholder"></div>

      <!-- main content -->
      <div id="app">Loading dashboard...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main.js"></script>

    <script>
      // Render navbar (based on original partial)
      function renderNavbar(user, path) {
        const container = document.getElementById('navbar-placeholder');
        const userName = user?.name || '';
        const userInitial = userName.charAt(0) ? userName.charAt(0).toUpperCase() : '';
        const role = user?.role || '';

        const navHtml = `
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
          <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-motorcycle me-2"></i>FixOnTheGo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav me-auto">
                ${role === 'mechanic' ? `
                  <li class="nav-item"><a class="nav-link ${path === '/mechanic/dashboard' ? 'active' : ''}" href="/mechanic/dashboard"><i class="fas fa-tachometer-alt me-1"></i> Dashboard</a></li>
                  <li class="nav-item"><a class="nav-link ${path === '/mechanic/history' ? 'active' : ''}" href="/mechanic/history"><i class="fas fa-history me-1"></i> Job History</a></li>
                ` : ''}
              </ul>
              <ul class="navbar-nav">
                ${user ? `
                  <li class="nav-item"><a class="nav-link" href="/chat"><i class="fas fa-comments"></i></a></li>
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" data-bs-toggle="dropdown">
                      <div class="d-flex align-items-center"><div class="avatar-circle-sm bg-white text-primary me-2">${userInitial}</div><span class="d-none d-md-inline">${userName}</span></div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                      <li><div class="dropdown-item-text"><div class="d-flex align-items-center"><div class="avatar-circle bg-primary text-white me-2">${userInitial}</div><div><div class="fw-bold">${userName}</div><div class="text-muted small">${user.email || ''}</div></div></div></div></li>
                      <li><hr class="dropdown-divider" /></li>
                      <li><a class="dropdown-item" href="/mechanic/profile"><i class="fas fa-user-cog me-2"></i> My Profile</a></li>
                      <li><a class="dropdown-item" href="/mechanic/dashboard"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a></li>
                      <li><hr class="dropdown-divider" /></li>
                      <li><a class="dropdown-item" href="/auth/logout"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                    </ul>
                  </li>
                ` : `
                  <li class="nav-item"><a class="nav-link" href="/auth/login">Login</a></li>
                `}
              </ul>
            </div>
          </div>
        </nav>`;

        container.innerHTML = navHtml;
      }

      function renderMessages(messages) {
        const container = document.getElementById('messages-placeholder');
        container.innerHTML = '';
        // messages can be an array of {type:'success'|'error', text: '...'}
        if (!messages) return;
        messages.forEach(m => {
          const div = document.createElement('div');
          div.className = `alert alert-${m.type} alert-dismissible fade show`;
          div.setAttribute('role','alert');
          div.innerHTML = `<div class="d-flex align-items-center"><i class="fas fa-check-circle me-2"></i><div>${m.text}</div></div><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
          container.appendChild(div);
        });
      }

      async function fetchData() {
        const res = await fetch('/mechanic/api/dashboard');
        if (!res.ok) {
          document.getElementById('app').innerText = 'Failed to load dashboard';
          return;
        }
        const data = await res.json();
        renderNavbar(data.user, '/mechanic/dashboard');
        renderMessages([]);
        renderDashboard(data);
      }

      function renderDashboard(data) {
        const user = data.user || {};
        const profile = data.profile || {};
        const stats = data.stats || {};
        const totalEarnings = data.totalEarnings || 0;
        const todayEarnings = data.todayEarnings || 0;

        const html = `
          <div class="container-fluid py-4">
            <div class="row"><div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0"><i class="fas fa-tools text-primary me-2"></i> Mechanic Dashboard</h1>
                <form action="/mechanic/toggle-availability" method="POST" class="d-inline"><button type="submit" class="btn btn-${profile.availability ? 'success' : 'danger'}"><i class="fas fa-${profile.availability ? 'check-circle' : 'times-circle'} me-2"></i>${profile.availability ? 'Available for Jobs' : 'Currently Unavailable'}</button></form>
              </div></div></div>

            <div class="row mb-4">
              <div class="col-md-3"><div class="card stats-card bg-success-gradient text-white"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h3 class="mb-0">$${todayEarnings.toFixed(2)}</h3><p class="mb-0">Today's Earnings</p></div><div class="stats-icon"><i class="fas fa-dollar-sign"></i></div></div></div></div></div>
              <div class="col-md-3"><div class="card stats-card bg-primary-gradient text-white"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h3 class="mb-0">${stats.inProgress || 0}</h3><p class="mb-0">Active Jobs</p></div><div class="stats-icon"><i class="fas fa-tools"></i></div></div></div></div></div>
              <div class="col-md-3"><div class="card stats-card bg-info-gradient text-white"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h3 class="mb-0">${stats.completed || 0}</h3><p class="mb-0">Completed Jobs</p></div><div class="stats-icon"><i class="fas fa-check-circle"></i></div></div></div></div></div>
              <div class="col-md-3"><div class="card stats-card bg-warning-gradient text-white"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h3 class="mb-0">$${totalEarnings.toFixed(2)}</h3><p class="mb-0">Total Earnings</p></div><div class="stats-icon"><i class="fas fa-money-bill-wave"></i></div></div></div></div></div>
            </div>

            <div class="row">
              <div class="col-md-8">
                <div class="card mb-4">
                  <div class="card-header d-flex justify-content-between align-items-center bg-white"><h5 class="mb-0"><i class="fas fa-clipboard-list text-primary me-2"></i>Current Bookings</h5><a href="/mechanic/history" class="btn btn-sm btn-outline-primary">View All</a></div>
                  <div class="card-body" id="current-bookings"></div>
                </div>
                <!-- Nearby and user requested cards could be added here similarly -->
              </div>
              <div class="col-md-4">
                <div class="card mb-4"><div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>Performance Stats</h5></div><div class="card-body"><canvas id="bookingChart" height="250"></canvas></div></div>
                <div class="card mb-4"><div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-user-cog text-primary me-2"></i>Your Profile</h5></div><div class="card-body"><div class="text-center mb-4"><div class="avatar-circle-large bg-primary text-white mx-auto mb-3">${(user.name||'').charAt(0).toUpperCase()}</div><h5>${user.name||''}</h5><div class="d-flex justify-content-center"><span class="ms-1">(${(profile.rating||0).toFixed ? (profile.rating||0).toFixed(1) : (profile.rating||0)})</span></div></div><div class="mb-3"><div class="d-flex justify-content-between mb-2"><span class="text-muted">Specialization</span><span>${(profile.specialization||[]).join(', ')}</span></div><div class="d-flex justify-content-between mb-2"><span class="text-muted">Experience</span><span>${profile.experience||0} years</span></div><div class="d-flex justify-content-between mb-2"><span class="text-muted">Hourly Rate</span><span class="text-success fw-bold">$${profile.hourlyRate||0}</span></div><div class="d-flex justify-content-between"><span class="text-muted">Status</span><span class="badge bg-${profile.availability ? 'success' : 'danger'}">${profile.availability ? 'Available' : 'Unavailable'}</span></div></div><div class="d-grid"><a href="/mechanic/profile" class="btn btn-outline-primary"><i class="fas fa-edit me-2"></i> Edit Profile</a></div></div></div>
                <div class="card"><div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-map-marker-alt text-primary me-2"></i>Your Location</h5></div><div class="card-body p-0"><div id="user-map" style="height: 300px"></div></div></div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('app').innerHTML = html;

        // Render current bookings
        const bookingsContainer = document.getElementById('current-bookings');
        const bookings = (data.bookings || []).filter(b => ['accepted','in-progress'].includes(b.status));
        if (bookings.length === 0) {
          bookingsContainer.innerHTML = `<div class="text-center py-5"><img src="/images/empty-jobs.png" alt="No Active Jobs" class="img-fluid mb-3" style="max-width:200px"/><h5>No active jobs found</h5><p class="text-muted">You don't have any active jobs at the moment.</p></div>`;
        } else {
          const table = document.createElement('table');
          table.className = 'table table-hover align-middle';
          table.innerHTML = `<thead class="table-light"><tr><th>Date</th><th>Customer</th><th>Problem</th><th>Status</th><th>Action</th></tr></thead><tbody>${bookings.map(booking => `
            <tr>
              <td>${new Date(booking.createdAt).toLocaleDateString()}</td>
              <td><div class="d-flex align-items-center"><div class="avatar-circle bg-primary text-white me-2">${(booking.user?.name||'').charAt(0).toUpperCase()}</div><div><span>${booking.user?.name||''}</span><small class="d-block text-muted">${booking.user?.phone||''}</small></div></div></td>
              <td title="${booking.problemCategory||''}">${booking.problemCategory||''}</td>
              <td><span class="booking-status status-${booking.status}" id="booking-status-${booking._id}">${booking.status}</span></td>
              <td><div class="btn-group"><a href="/mechanic/booking/${booking._id}" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> View</a><a href="/chat/${booking._id}" class="btn btn-sm btn-info"><i class="fas fa-comments"></i> Chat</a></div></td>
            </tr>`).join('')}</tbody>`;
          bookingsContainer.innerHTML = '';
          bookingsContainer.appendChild(table);
        }

        // Chart
        const ctx = document.getElementById('bookingChart').getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Completed', 'In Progress', 'Accepted', 'Cancelled'],
            datasets: [{data: [stats.completed||0, stats.inProgress||0, stats.pending||0, stats.cancelled||0], backgroundColor:['#38b000','#4361ee','#f8961e','#ef476f'], borderWidth:0}]
          },
          options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{boxWidth:12, padding:15}}}}
        });

        // Initialize map (leaflet)
        (function(){
          const LScript = document.createElement('script'); LScript.src = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.js'; document.body.appendChild(LScript);
          LScript.onload = function(){
            const map = L.map('user-map').setView([0,0],13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
            const lat = user?.location?.coordinates?.[1] || 0;
            const lng = user?.location?.coordinates?.[0] || 0;
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position){ map.setView([position.coords.latitude, position.coords.longitude],15); const marker = L.marker([position.coords.latitude, position.coords.longitude]).addTo(map); marker.bindPopup('Your current location').openPopup(); }, function(){ if(lat && lng) { map.setView([lat,lng],15); L.marker([lat,lng]).addTo(map).bindPopup('Your location').openPopup(); } });
            } else { if(lat && lng){ map.setView([lat,lng],15); L.marker([lat,lng]).addTo(map).bindPopup('Your location').openPopup(); } }
          };
        })();
      }

      fetchData().catch(err=>{console.error(err); document.getElementById('app').innerText='Error loading dashboard';});
    </script>
  </body>
</html>